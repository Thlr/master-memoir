\documentclass[12pt, aspectratio=43]{beamer}
\usepackage[backend=bibtex, style=authoryear]{biblatex} % bibliography
\usepackage{multirow}
\usepackage{adjustbox}
\usepackage{tikz}

% HACKS A CUSTOM COMMANDS
\newcommand{\backupbegin}{
   \newcounter{framenumberappendix}
   \setcounter{framenumberappendix}{\value{framenumber}}
}
\newcommand{\backupend}{
   \addtocounter{framenumberappendix}{-\value{framenumber}}
   \addtocounter{framenumber}{\value{framenumberappendix}} 
}
\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;} 

% BEAMER TEMPLATE AND THEME
\setbeamertemplate{footline}[frame number]
\usetheme{Estonia}
\mode<presentation>
\AtBeginSection[]{
  \begin{frame}
  \vfill
  \centering
  \begin{beamercolorbox}[sep=8pt,center,shadow=true,rounded=true]{title}
    \usebeamerfont{title}\insertsectionhead\par%
  \end{beamercolorbox}
  \vfill
  \end{frame}
}

\addbibresource{../biblio.bib}

% TITLE PAGE
\title{Kubernetes cluster simulator based on Batsim}
\title{Development and evaluation of a Kubernetes cluster simulator based on
Batsim}

\author{\textbf{Presented by:} Théo Larue\\\textbf{Supervised by:} Olivier
Richard \& Michael Mercier}

\date{August 31, 2020}

\institute[Théo LARUE]{Université Grenoble Alpes}

\titlegraphic{
	\includegraphics[height=5ex]{../imgs/uga-logo.png}\hspace{2ex}
	\includegraphics[height=6ex]{../imgs/ENSIMAG.png}\hspace{2ex}
	\includegraphics[height=5ex]{../imgs/Logo-LIG.jpg}\hspace{2ex}
	\includegraphics[height=5ex]{../imgs/ryax-logo.png}
}

\begin{document}

\frame{\titlepage}

\begin{frame}{Table of contents}
	\tableofcontents
\end{frame}

\section{Introduction}

\begin{frame}{Resource and Jobs Management System}
	\begin{columns}
		\column{0.7\textwidth}
		The RJMS is at the core of the cluster.
		\begin{exampleblock}{Examples of RJMS}
			\begin{itemize}
				\item OAR
				\item SLURM
				\item HadoopYARN
				\item Apache Mesos
			\end{itemize}
		\end{exampleblock}

		\column{0.3\textwidth}
		\centering
		\includegraphics[scale=0.6]{../imgs/RJMS.pdf}
	\end{columns}
\end{frame}


\begin{frame}{Kubernetes}
	\begin{columns}
		\column{0.7\textwidth}
		\begin{block}{Kubernetes in a nutshell}
			\begin{itemize}
				\item Open source resource manager for
					containerized applications
				\item About 2M lines of code
				\item 2.8k contributors
			\end{itemize}
		\end{block}

		\column{0.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../imgs/kube-logo.png}
	\end{columns}

	\centering
	\includegraphics[width=\textwidth]{../imgs/container_evolution.png}
	\tiny{source: \url{https://kubernetes.io/docs/}}
\end{frame}

\begin{frame}{A component of the RJMS: the scheduler}
	\begin{columns}
		\column{0.5\textwidth}
		\includegraphics[width=\textwidth]{../imgs/gantt_small.png}
		\textbf{Scheduling} is the act of allocating tasks to resources.

		\column{0.5\textwidth}
		\begin{exampleblock}{Numerous factors}
			\begin{itemize}
				\item Workloads
				\item Applications
				\item System size
				\item Network topology
				\item Energy consumption
				\item Scheduling policies
			\end{itemize}
		\end{exampleblock}

		Complex implementations: Kubernetes default
		scheduler weighs \textbf{47k lines of code}.
	\end{columns}
\end{frame}

\begin{frame}{Studying schedulers}
	\begin{columns}
		\column{0.4\textwidth}
		\begin{block}{Different approaches}
			\begin{itemize}
				\item Analytical study
				\item Real experiments
				\item Emulation
				\item \textbf{Simulation}
			\end{itemize}
		\end{block}

		\column{0.6\textwidth}
		\centering
		\includegraphics[scale=0.3]{../imgs/batsim-logo.png}

		\vspace{4ex}

		\includegraphics[scale=0.3]{../imgs/batsim-sequence-diag.png}

		\small{Batsim, an infrastructure simulator aimed at studying RJMS.}
	\end{columns}
\end{frame}

\begin{frame}{Contribution}
	\begin{columns}
		\column{0.7\textwidth}
		\includegraphics[width=\textwidth]{../imgs/problematic.pdf}

		\vspace{1cm}

		\includegraphics[width=\textwidth]{../imgs/contribution.pdf}

		\column{0.38\textwidth}
		\begin{exampleblock}{Batkube supports}
			\begin{itemize}
				\item Any Go scheduler
				\item Any cluster size
				\item Resource requests
				\item Non parallel tasks
			\end{itemize}
		\end{exampleblock}
	\end{columns}
\end{frame}

\section{Literature review}

\begin{frame}{Infrastructure simulators}
	TODO or fix
\end{frame}

%\begin{frame}[allowframebreaks]{Infrastructure simulators}
%	TODO: what to do with this slide?
%	\begin{adjustbox}{max width=\textwidth}
%		\begin{tabular}{cccccc}
%			\hline
%			& Grid & HPC & Cloud & Peer to Peer & Volunteer Computing\\\hline
%			\textbf{SimGrid} & \checkmark & & & &\\
%			GridSim & \checkmark & & & &\\
%			LogGOPSim & & \checkmark & & &\\
%			BigSim & & \checkmark & & &\\
%			CloudSim & & & \checkmark  & &\\
%			GroudSim & \checkmark & & \checkmark & &\\
%			PeerSim & & & & \checkmark &\\
%			OverSim & & & & \checkmark &\\
%			SimBA & & & & & \checkmark \\
%			SimBOINC & & & & & \checkmark \\
%			\hline
%		\end{tabular}
%	\end{adjustbox}
%	\centering
%	\small{Domain specific simulators}
%
%	\framebreak
%	\begin{columns}
%		\column{0.6\textwidth}
%		\begin{exampleblock}{Software specific simulators}
%			\begin{itemize}
%				\item YARNSim
%				\item SLURM simulator
%			\end{itemize}
%		\end{exampleblock}
%
%		\begin{block}{Publication specific simulators}
%			``Publish and perish'' - Milian Poquet
%		\end{block}
%
%		\column{0.4\textwidth}
%		\begin{exampleblock}{Simulators for the study of RJMS}
%			\begin{itemize}
%				\item Batsim
%				\item Alea
%				\item Accasim
%			\end{itemize}
%		\end{exampleblock}
%	\end{columns}
%\end{frame}

%\begin{frame}{SimGrid}
%	SimGrid: Versatile, scalable, accurate.
%
%	Cpu = a computation speed.\\
%	Storage = a seek time and a data transfert rate.\\
%	Network = a flow model, modeling bandwith sharing behaviors.
%
%	Simple models but thoroughly validated.
%\end{frame}

\begin{frame}{Kubernetes cluster simulation}
	TODO: recap table of these two schedulers
	k8s-cluster-simulator: open source, student project, delay jobs.
	Schedulers provided via a Go interface.

	joySim: closed-source, fully fledged kubernetes cluster simulator,
	service oriented (mock nodes).

	TODO: recap kubernetes schedulers 

\end{frame}

\section{Integrating Kubernetes schedulers to Batsim}

\begin{frame}{Different communication paradigms}
	\begin{columns}
		\column{0.4\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../imgs/case1_protocol.png}
		{\tiny source: \url{https://batsim.readthedocs.io}}
		\begin{itemize}
			\item Event based
			\item Simulation time
		\end{itemize}

		\column{0.7\textwidth}
		\includegraphics[width=\textwidth]{../imgs/kubernetes-components.pdf}
		{\tiny source: \url{https://kubernetes.io/docs/concepts/overview/components/}}
		\begin{itemize}
			\item Central API
			\item Real time
		\end{itemize}
	\end{columns}
\end{frame}

\begin{frame}{Time synchronization}
	\begin{columns}
		\column{0.55\textwidth}
		\includegraphics[scale=0.65]{../imgs/time-sync-correct.pdf}

		\small{Scenario 1: correct synchronization}

		\column{0.55\textwidth}
		\includegraphics[scale=0.6]{../imgs/time-sync-delayed.pdf}

		\small{Scenario 2: delayed decision}
	\end{columns}
\end{frame}

\begin{frame}{Technical challenges}
	\begin{alertblock}{Challenges to tackle}
		\begin{enumerate}
			\item Integration with Kubernetes
			\item Scheduler time interception
			\item Time synchronization
		\end{enumerate}
	\end{alertblock}
\end{frame}

\begin{frame}{Architeture of Batkube}
	\centering
	\includegraphics[width=\textwidth]{../imgs/batkube-architecture-3-synchro.pdf}
	\small{Global architecture of Batkube.}
\end{frame}

\begin{frame}{Time interception}
	\begin{columns}
		\column{0.5\textwidth}
		TODO: explain code source manipulation with AST
		
		\column{0.5\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../imgs/synchro-go-sources.pdf}\\
		\small{Schedulers are patched to redirect their time.}
	\end{columns}
\end{frame}

\begin{frame}{Time synchronization}
	\centering
	\includegraphics[width=\textwidth]{../imgs/lignes_de_temps_simple.pdf}\\
	\small{Time synchronization between Batsim and the scheduler}
\end{frame}

\begin{frame}[allowframebreaks]{Parameters of the synchronization}
		\centering
		\includegraphics[width=\textwidth]{../imgs/timeout.pdf}\\
		Timeout value

		\includegraphics[width=0.9\textwidth]{../imgs/max-timestep.pdf}\\
		Simulation time step $\in$ [\texttt{base-simulation-timestep}, \texttt{max-simulation-timestep}]
\end{frame}

\section{Study of the simulator}

\begin{frame}{Experimental design}
	TODO: Scheduler used, platforms and workloads tested, what experiments (parameters, metrics studied, repetitions)
	%\centering
	%\begin{tabular}{|c|c|c|c|c|c|}
	%	\hline\\
	%	name & number of jobs & jobs type & sub time & resource requests & platform
	%	\hline\\
	%	burst & 200 & delay (170s) & at time zero & 1 cpu & 16x1\\
	%	spaced & 200 & delay (170s) & every ten seconds & 1 cpu & 16x1\\
	%\end{tabular}
\end{frame}

\begin{frame}[allowframebreaks]{Timeout}
	\centering
	\includegraphics[width=\textwidth]{../imgs/timeout_burst_spaced.png}
	\includegraphics[width=\textwidth]{../imgs/timeout_realistic.png}
\end{frame}

\begin{frame}[allowframebreaks]{Maximum simulation timestep}
	\centering
	\includegraphics[width=\textwidth]{../imgs/max-timestep_burst_sp.png}
	\includegraphics[width=\textwidth]{../imgs/max-timestep_realistic.png}
\end{frame}

\begin{frame}{Experimentation on a real cluster}
	\centering
	\includegraphics[width=0.8\textwidth]{../imgs/expe-protocole-v2.pdf}
\end{frame}

\begin{frame}{Deviation with reality}
	\centering
	\begin{adjustbox}{max width=\textwidth}
		\begin{tabular}{|c|c|c|c|c|c|c|c|c|}
			\hline

			\multirow{3}{*}{workload} & \multicolumn{4}{c|}{\textbf{makespan}} & \multicolumn{4}{c|}{\textbf{mean waiting time}}\\

			\cline{2-9}

			& \multicolumn{2}{c|}{emulated} &
			\multicolumn{2}{c|}{simulated} & \multicolumn{2}{c|}{emulated}
			& \multicolumn{2}{c|}{simulated} \\

			\cline{2-9}

			& $\mu$ & $\sigma$ & $\mu$ & $\sigma$ & $\mu$ & $\sigma$ & $\mu$ & $\sigma$ \\

			\hline

			burst & 2467 & 28.3 & 2215 (-252) & 0.508 & 1077 & 10.6 & 970 (-107) & 12.6 \\
			spaced & 2468 & 5.14 & 2257 (-211) & 16.9 & 146 & 1.67 & 48.1 (-97.9) & 9.44 \\
			realistic & 32556 & - & 32555 (-1) & 1.30 & 2884 & - & 2020 (-864) & 950 \\
			\hline
		\end{tabular}
	\end{adjustbox}
\end{frame}

\begin{frame}{Conclusion}
	Deviation with reality: can be fixed with some work on the api. Need
	experiments to measur and quantify this deviation.

	max timestep: studying max timestep alone is not enough, need to study
	it with backoff multiplier.

	base time step: need an experiment on it. Too much importance was
	credited to max timestep, the base timestep might have importance.
\end{frame}

\section{Discussion and future work}
\begin{frame}{Capabilities and limitations of Batkube}
	WIP
	\begin{columns}
		\column{0.5\textwidth}
		\begin{block}{Capabilities}
			\begin{itemize}
				\item Delay jobs
				\item Cpu and memory requests
				\item Can patch any kubernetes scheduler written in Go
				\item The api only supports the default scheduler
			\end{itemize}
		\end{block}

		\column{0.5\textwidth}
		\begin{alertblock}{Limitations}
			\begin{itemize}
				\item Memory hungry (in fact, the scheduler is memory hungry)
				\item Some problems with the scheduler
				\item Not scalable
			\end{itemize}
		\end{alertblock}
	\end{columns}
\end{frame}

\begin{frame}{Perspectives for future work}
	- parallel jobs\\
	- storage\\
	- more complete api: support for more schedulers but also tools (monitoring tools)
\end{frame}

\section*{}
\backupbegin
\begin{frame}[allowframebreaks]
        \frametitle{References}
	\printbibliography
\end{frame}

\begin{frame}{Any questions?}
	\centering
	Thank you for your attention.

	I am open to any questions.
\end{frame}

\appendix
\begin{frame}{Batkube integration with Kubernetes}
	\centering
	\includegraphics[width=0.8\textwidth]{../imgs/custom-api.pdf}\\
	\small{Reimplementation of a custom API.}
\end{frame}

\begin{frame}{Time interception}
	\centering
	\includegraphics[width=0.6\textwidth]{../imgs/synchro-go-sources.pdf}\\
	\small{Schedulers are patched to redirect their time.}
\end{frame}

\begin{frame}{batsky-go}
	\begin{columns}
		\column{0.5\textwidth}
		\centering
		\includegraphics[scale=0.38]{../imgs/requester-broker.pdf}
		
		\column{0.5\textwidth}
		Exchanges between the scheduler, batsky-go (``time'') and Batsim
	\end{columns}
\end{frame}

\begin{frame}{Similar resources}
	\begin{columns}
		\column{0.5\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../imgs/node-overview.png}
		\tiny{source: \url{https://kubernetes.io/docs/tutorials/kubernetes-basics/explore/explore-intro/}}

		\column{0.5\textwidth}
		\begin{block}{Translation between Kubernetes and Batsim}
			\begin{itemize}
				\item A Pod = a job.
				\item A Node = a compute resource.
			\end{itemize}
		\end{block}
	\end{columns}
\end{frame}

\backupend
\end{document}
